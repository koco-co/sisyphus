name: 等待和循环功能测试
description: 测试等待执行器和循环执行器的功能

config:
  name: Wait and Loop Test Suite
  timeout: 300
  retry_times: 0

steps:
  # ========== 等待功能测试 ==========

  - name: 固定时间等待测试
    type: wait
    seconds: 2
    description: 等待2秒

  - name: 条件等待测试
    type: wait
    condition: "{{ready}}"
    interval: 0.5
    max_wait: 5
    description: 等待变量ready为true（使用setup设置）

  # ========== For循环测试 ==========

  - name: For循环基础测试
    type: loop
    loop_type: for
    loop_count: 3
    loop_variable: iteration
    loop_steps:
      - name: 内部API请求-{{iteration}}
        type: request
        method: GET
        url: https://httpbin.org/get?iteration={{iteration}}
        validations:
          - type: eq
            path: $.args.iteration
            expect: "{{iteration}}"
            description: 验证iteration参数正确

  - name: For循环变量提取测试
    type: loop
    loop_type: for
    loop_count: 2
    loop_variable: i
    loop_steps:
      - name: 提取数据-{{i}}
        type: request
        method: GET
        url: https://httpbin.org/get?index={{i}}
        extractors:
          - name: url_{{i}}
            type: jsonpath
            path: $.url

  # ========== While循环测试 ==========

  - name: While循环基础测试
    type: loop
    loop_type: while
    loop_condition: "{{continue_loop}}"
    loop_variable: while_index
    loop_steps:
      - name: while循环步骤-{{while_index}}
        type: request
        method: GET
        url: https://httpbin.org/get?while_index={{while_index}}
        extractors:
          - name: response_url
            type: jsonpath
            path: $.url

  - name: 设置循环继续条件为true
    type: request
    method: GET
    url: https://httpbin.org/get
    extractors:
      - name: continue_loop
        type: jsonpath
        path: $.url
        transform: "true"  # 这将触发while循环

  # ========== 组合测试 ==========

  - name: 等待后执行循环
    type: wait
    seconds: 1
    description: 等待1秒后执行循环

  - name: 组合循环测试
    type: loop
    loop_type: for
    loop_count: 2
    loop_variable: idx
    loop_steps:
      - name: 循环内等待-{{idx}}
        type: wait
        seconds: 0.5
        description: 在循环内等待0.5秒

      - name: 循环内请求-{{idx}}
        type: request
        method: GET
        url: https://httpbin.org/get?idx={{idx}}
        validations:
          - type: eq
            path: $.args.idx
            expect: "{{idx}}"

# Setup: 设置测试所需的变量
setup:
  - set_var:
      ready: "true"
      continue_loop: "false"
