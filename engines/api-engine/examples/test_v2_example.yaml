# Sisyphus API Engine - V2.0 Protocol Example
# This example demonstrates the new v2.0 YAML format

name: "用户登录测试套件"
description: "测试用户登录接口的各种场景"

config:
  name: "登录测试配置"
  description: "测试环境的配置"

  # 环境配置
  profiles:
    dev:
      base_url: "http://dev-api.example.com"
      variables:
        env_name: "开发环境"
        timeout: 30

    test:
      base_url: "http://test-api.example.com"
      variables:
        env_name: "测试环境"
        timeout: 20

    prod:
      base_url: "https://api.example.com"
      variables:
        env_name: "生产环境"
        timeout: 10

  # 当前激活的环境
  active_profile: "dev"

  # 全局变量
  variables:
    api_version: "v1"
    max_retries: 3

  # 全局配置
  timeout: 30
  retry_times: 2
  concurrent: false

# 全局前置钩子
setup:
  - log: "开始执行登录测试套件"

# 全局后置钩子
teardown:
  - log: "登录测试套件执行完成"

# 测试步骤
steps:
  # 步骤1: 用户登录成功
  - 用户登录成功:
      type: request
      url: "{{config.profiles[active_profile].base_url}}/{{config.variables.api_version}}/user/login"
      method: POST
      headers:
        Content-Type: "application/json"
        User-Agent: "Sisyphus-Test-Runner/2.0"
      body:
        username: "testuser"
        password: "password123"
      validations:
        - type: eq
          path: "$.code"
          expect: 200
          description: "检查响应状态码为200"
        - type: eq
          path: "$.message"
          expect: "success"
          description: "检查响应消息为success"
        - type: contains
          path: "$.data.token"
          expect: "."
          description: "检查token字段包含点号（JWT格式）"
      extractors:
        - name: token
          type: jsonpath
          path: "$.data.token"
          description: "提取登录token用于后续请求"

  # 步骤2: 获取用户信息
  - 获取用户信息:
      type: request
      url: "{{config.profiles[active_profile].base_url}}/{{config.variables.api_version}}/user/info"
      method: GET
      headers:
        Authorization: "Bearer {{token}}"
        Content-Type: "application/json"
      validations:
        - type: eq
          path: "$.code"
          expect: 200
          description: "检查响应状态码为200"
        - type: eq
          path: "$.data.username"
          expect: "testuser"
          description: "验证用户名正确"
      depends_on:
        - "用户登录成功"

  # 步骤3: 退出登录
  - 退出登录:
      type: request
      url: "{{config.profiles[active_profile].base_url}}/{{config.variables.api_version}}/user/logout"
      method: POST
      headers:
        Authorization: "Bearer {{token}}"
        Content-Type: "application/json"
      validations:
        - type: eq
          path: "$.code"
          expect: 200
          description: "检查退出成功"
      depends_on:
        - "用户登录成功"
        - "获取用户信息"

# 测试用例标签
tags:
  - "auth"
  - "login"
  - "smoke"

enabled: true
